<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - Shop.co</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Barra de promoci√≥n -->
    <div class="promo-bar">
        <p>Reg√≠strate y obt√©n 20% de descuento en tu primer pedido. <a href="#" class="sign-up-link">Reg√≠strate Ahora</a></p>
        <button class="close-button">√ó</button>
    </div>

    <!-- Contenedor para el navbar reutilizable -->
    <div class="navbar-container"></div>

    <div class="productos-container">
        <h2 id="titulo-categoria">Productos</h2>
        
        <div class="productos-layout">
            <!-- Sidebar de filtros -->
            <aside class="filtros-sidebar">
                <div class="filtro-header">
                    <h3>Filtros</h3>
                    <button id="limpiar-filtros" class="btn-limpiar">Limpiar filtros</button>
                </div>

                <!-- Filtro de Color -->
                <div class="filtro-seccion">
                    <h4>Color</h4>
                    <div class="color-grid" id="filtro-colores">
                        <!-- Los colores se cargar√°n din√°micamente -->
                    </div>
                </div>
            </aside>

            <!-- Contenido principal -->
            <main class="productos-main">
                <div class="productos-header">
                    <div class="productos-count" id="productos-count">0 productos encontrados</div>
                    <div class="productos-sort">
                        <select id="ordenamiento" class="select-ordenar">
                            <option value="">Ordenar por</option>
                            <option value="precio-asc">Precio: Menor a Mayor</option>
                            <option value="precio-desc">Precio: Mayor a Menor</option>
                            <option value="nombre-asc">Nombre: A-Z</option>
                            <option value="nombre-desc">Nombre: Z-A</option>
                        </select>
                    </div>
                </div>

                <div id="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Cargando productos...</span>
                </div>
                <div id="error" style="display: none;"></div>
                <div class="productos-grid" id="productos-grid">
                    <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-top">
            <div class="footer-logo">
                <svg width="160" height="40" viewBox="0 0 160 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <text x="0" y="30" font-family="'Dekko', cursive" font-size="32" fill="#111" font-weight="bold" letter-spacing="2">OutfitAI</text>
                </svg>
            </div>
            <p class="footer-description">
                Plataforma innovadora que combina inteligencia artificial con moda para ofrecer recomendaciones personalizadas de outfits. Utilizando Gemini IA y an√°lisis de datos en tiempo real, transformamos la experiencia de compra de ropa en una aventura de estilo inteligente.
            </p>
            <div class="social-links">
                <a href="#" class="social-link">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" />
                    </svg>
                </a>
                <a href="#" class="social-link">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" />
                    </svg>
                </a>
                <a href="#" class="social-link">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <rect x="2" y="2" width="20" height="20" rx="5" />
                        <path d="M12 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6z" fill="white" />
                        <circle cx="17" cy="7" r="1" fill="white" />
                    </svg>
                </a>
                <a href="https://github.com/Flores41/TESIS-WEB" class="social-link" target="_blank" rel="noopener">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z" />
                    </svg>
                </a>
            </div>
            <div class="footer-copyright">
                <p class="copyright-text">¬© 2024 <span>OutfitAI</span>. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script type="module">
        import { db, auth, verificarFavorito, toggleFavorito } from './js/firebase-config.js';
        import { collection, getDocs, query, where, doc, getDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        let todosLosProductos = [];
        let filtrosActivos = {
            colores: new Set(),
            ordenamiento: ''
        };

        // Cache para productos
        const CACHE_KEY = 'productos_cache';
        const CACHE_EXPIRY = 1000 * 60 * 5; // 5 minutos

        // Funci√≥n para guardar en cach√©
        function guardarEnCache(key, data) {
            const cacheData = {
                timestamp: Date.now(),
                data: data
            };
            localStorage.setItem(key, JSON.stringify(cacheData));
        }

        // Funci√≥n para obtener del cach√©
        function obtenerDeCache(key) {
            const cached = localStorage.getItem(key);
            if (!cached) return null;

            const { timestamp, data } = JSON.parse(cached);
            if (Date.now() - timestamp > CACHE_EXPIRY) {
                localStorage.removeItem(key);
                return null;
            }
            return data;
        }

        // Obtener par√°metros de la URL
        const params = new URLSearchParams(window.location.search);
        const genero = params.get('genero');
        const categoria = params.get('categoria');

        // Actualizar el t√≠tulo
        const tituloCategoriaElement = document.getElementById('titulo-categoria');
        if (categoria) {
            const categoriaCapitalizada = categoria.charAt(0).toUpperCase() + categoria.slice(1);
            tituloCategoriaElement.textContent = `${categoriaCapitalizada} - ${genero.charAt(0).toUpperCase() + genero.slice(1)}`;
        }

        // Funci√≥n para inicializar filtros de color
        function inicializarFiltrosColor(productos) {
            const coloresUnicos = new Set();
            productos.forEach(producto => {
                if (producto.color) {
                    coloresUnicos.add(producto.color.toLowerCase());
                }
            });

            const filtroColores = document.getElementById('filtro-colores');
            filtroColores.innerHTML = '';

            coloresUnicos.forEach(color => {
                const colorBtn = document.createElement('button');
                colorBtn.className = 'color-btn';
                colorBtn.style.backgroundColor = color;
                colorBtn.setAttribute('data-color', color);
                colorBtn.title = color.charAt(0).toUpperCase() + color.slice(1);

                colorBtn.addEventListener('click', () => {
                    colorBtn.classList.toggle('selected');
                    if (colorBtn.classList.contains('selected')) {
                        filtrosActivos.colores.add(color);
                    } else {
                        filtrosActivos.colores.delete(color);
                    }
                    aplicarFiltros();
                });

                filtroColores.appendChild(colorBtn);
            });
        }

        // Event Listeners para filtros
        document.getElementById('ordenamiento').addEventListener('change', (e) => {
            filtrosActivos.ordenamiento = e.target.value;
            aplicarFiltros();
        });

        document.getElementById('limpiar-filtros').addEventListener('click', () => {
            // Resetear filtros
            filtrosActivos = {
                colores: new Set(),
                ordenamiento: ''
            };

            // Resetear UI
            document.getElementById('ordenamiento').value = '';
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('selected'));

            aplicarFiltros();
        });

        // Funci√≥n para aplicar filtros
        function aplicarFiltros() {
            let productosFiltrados = [...todosLosProductos];

            // Filtrar por color
            if (filtrosActivos.colores.size > 0) {
                productosFiltrados = productosFiltrados.filter(producto => 
                    producto.color && filtrosActivos.colores.has(producto.color.toLowerCase())
                );
            }

            // Aplicar ordenamiento
            if (filtrosActivos.ordenamiento) {
                switch(filtrosActivos.ordenamiento) {
                    case 'precio-asc':
                        productosFiltrados.sort((a, b) => {
                            const precioA = parseFloat(a.precio.replace(/[^0-9.]/g, ''));
                            const precioB = parseFloat(b.precio.replace(/[^0-9.]/g, ''));
                            return precioA - precioB;
                        });
                        break;
                    case 'precio-desc':
                        productosFiltrados.sort((a, b) => {
                            const precioA = parseFloat(a.precio.replace(/[^0-9.]/g, ''));
                            const precioB = parseFloat(b.precio.replace(/[^0-9.]/g, ''));
                            return precioB - precioA;
                        });
                        break;
                    case 'nombre-asc':
                        productosFiltrados.sort((a, b) => a.nombre.localeCompare(b.nombre));
                        break;
                    case 'nombre-desc':
                        productosFiltrados.sort((a, b) => b.nombre.localeCompare(a.nombre));
                        break;
                }
            }

            // Actualizar contador de productos
            document.getElementById('productos-count').textContent = 
                `${productosFiltrados.length} productos encontrados`;

            // Mostrar productos filtrados
            mostrarProductos(productosFiltrados);
        }

        // Funci√≥n para mostrar productos
        function mostrarProductos(productos) {
            console.log(`üìã Mostrando ${productos.length} productos en la grilla`);
            const productosGrid = document.getElementById('productos-grid');
            productosGrid.innerHTML = '';

            productos.forEach(async (producto) => {
                const productoElement = document.createElement('div');
                productoElement.className = 'producto-card';
                productoElement.dataset.productId = producto.id;
                
                // Calcular descuento si existe precio anterior
                let descuentoHtml = '';
                if (producto.precioAntes) {
                    const precioActual = parseFloat(producto.precio.replace(/[^0-9.]/g, ''));
                    const precioAnterior = parseFloat(producto.precioAntes.replace(/[^0-9.]/g, ''));
                    const descuento = Math.round(((precioAnterior - precioActual) / precioAnterior) * 100);
                    if (descuento > 0) {
                        descuentoHtml = `<div class="descuento-badge">-${descuento}%</div>`;
                    }
                }

                // Hacer que toda la tarjeta sea clickeable
                productoElement.style.cursor = 'pointer';
                productoElement.onclick = () => {
                    const coleccion = genero === 'hombre' ? 'shombre' : 'smujer';
                    window.location.href = `producto-detalle.html?id=${producto.id}&coleccion=${coleccion}`;
                };

                // Verificar si el producto est√° en favoritos
                const esFavorito = await verificarFavorito(producto.id);
                const btnClass = esFavorito ? 'btn-agregar activo' : 'btn-agregar';
                const btnText = esFavorito ? 'Quitar de favoritos' : 'Agregar a favoritos';
                const corazon = esFavorito ? '‚ô•' : '‚ô°';

                productoElement.innerHTML = `
                    ${descuentoHtml}
                    <div class="producto-imagen">
                        <img src="${producto.imagen}" alt="${producto.nombre}">
                        <div class="producto-overlay">
                            <button class="${btnClass}" onclick="event.stopPropagation(); handleFavorito('${producto.id}', this, '${producto.nombre}')">
                                <span class="icono-corazon">${corazon}</span>
                                <span class="btn-text">${btnText}</span>
                            </button>
                        </div>
                    </div>
                    <div class="producto-info">
                        <h3>${producto.nombre}</h3>
                        <div class="precios-container">
                            <p class="precio-actual">${producto.precio}</p>
                            ${producto.precioAntes ? `<p class="precio-antes">${producto.precioAntes}</p>` : ''}
                        </div>
                    </div>
                    <div class="notificacion-favorito">
                        <span class="mensaje"></span>
                    </div>
                `;
                productosGrid.appendChild(productoElement);
            });
        }

        // Funci√≥n para manejar la interacci√≥n con favoritos
        async function handleFavorito(productoId, btnElement, nombreProducto) {
            if (!auth.currentUser) {
                alert('Debes iniciar sesi√≥n para agregar productos a favoritos');
                return;
            }

            try {
                const card = btnElement.closest('.producto-card');
                const notificacion = card.querySelector('.notificacion-favorito');
                const mensaje = notificacion.querySelector('.mensaje');
                const iconoCorazon = btnElement.querySelector('.icono-corazon');
                const btnTexto = btnElement.querySelector('.btn-text');

                // Agregar clase de animaci√≥n al bot√≥n
                btnElement.classList.add('pulsando');

                const esFavorito = btnElement.classList.contains('activo');
                const resultado = await toggleFavorito(productoId);

                if (resultado !== esFavorito) { // Si el estado cambi√≥ exitosamente
                    btnElement.classList.toggle('activo');
                    
                    if (btnElement.classList.contains('activo')) {
                        iconoCorazon.textContent = '‚ô•';
                        btnTexto.textContent = 'Quitar de favoritos';
                        mensaje.textContent = `¬°${nombreProducto} agregado a favoritos!`;
                        mensaje.style.backgroundColor = '#4CAF50';
                    } else {
                        iconoCorazon.textContent = '‚ô°';
                        btnTexto.textContent = 'Agregar a favoritos';
                        mensaje.textContent = `${nombreProducto} eliminado de favoritos`;
                        mensaje.style.backgroundColor = '#FF5252';
                    }

                    // Mostrar notificaci√≥n
                    notificacion.style.display = 'block';
                    notificacion.classList.add('mostrar');

                    // Ocultar notificaci√≥n despu√©s de 2 segundos
                    setTimeout(() => {
                        notificacion.classList.remove('mostrar');
                        setTimeout(() => {
                            notificacion.style.display = 'none';
                        }, 300);
                    }, 2000);
                }

                // Quitar clase de animaci√≥n despu√©s de un momento
                setTimeout(() => {
                    btnElement.classList.remove('pulsando');
                }, 300);

            } catch (error) {
                console.error('Error al gestionar favorito:', error);
                alert('Error al gestionar favoritos. Por favor, intenta de nuevo.');
            }
        }

        // Hacer la funci√≥n handleFavorito disponible globalmente
        window.handleFavorito = handleFavorito;

        // Agregar estilos necesarios
        const styles = document.createElement('style');
        styles.textContent = `
            .btn-agregar {
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 10px 20px;
                border-radius: 25px;
                border: none;
                background-color: white;
                color: #333;
                cursor: pointer;
                font-weight: 500;
            }

            .btn-agregar.activo {
                background-color: #FF4B4B;
                color: white;
            }

            .btn-agregar.pulsando {
                transform: scale(0.95);
            }

            .icono-corazon {
                font-size: 1.2em;
                transition: transform 0.3s ease;
            }

            .btn-agregar:hover .icono-corazon {
                transform: scale(1.2);
            }

            .notificacion-favorito {
                display: none;
                position: absolute;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%) translateY(20px);
                opacity: 0;
                transition: all 0.3s ease;
                z-index: 1000;
            }

            .notificacion-favorito.mostrar {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }

            .notificacion-favorito .mensaje {
                padding: 8px 16px;
                border-radius: 20px;
                color: white;
                font-size: 14px;
                white-space: nowrap;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            }

            .producto-card {
                position: relative;
            }
        `;
        document.head.appendChild(styles);

        // Funci√≥n para cargar productos
        async function cargarProductos() {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');

            try {
                loadingElement.style.display = 'flex';
                errorElement.style.display = 'none';

                console.log('üîç Cargando productos para:', { genero, categoria });

                // Intentar obtener productos del cach√©
                const cacheKey = `${CACHE_KEY}_${genero}_${categoria}`;
                const productosCache = obtenerDeCache(cacheKey);

                if (productosCache) {
                    console.log('üì¶ Productos obtenidos del cach√©');
                    todosLosProductos = productosCache;
                    inicializarFiltrosColor(todosLosProductos);
                    aplicarFiltros();
                    loadingElement.style.display = 'none';
                    return;
                }

                const coleccion = genero === 'hombre' ? 'shombre' : 'smujer';
                console.log('üîÑ Consultando colecci√≥n:', coleccion);
                
                const productosRef = collection(db, coleccion);
                const q = query(productosRef, where("categoria", "==", categoria));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log('‚ö†Ô∏è No se encontraron productos en esta categor√≠a');
                    errorElement.textContent = 'No se encontraron productos en esta categor√≠a.';
                    errorElement.style.display = 'block';
                    return;
                }

                todosLosProductos = [];
                querySnapshot.forEach((doc) => {
                    const producto = doc.data();
                    todosLosProductos.push(producto);
                });

                console.log(`‚úÖ Se encontraron ${todosLosProductos.length} productos`);

                // Guardar en cach√©
                guardarEnCache(cacheKey, todosLosProductos);
                console.log('üíæ Productos guardados en cach√©');

                // Inicializar filtros
                inicializarFiltrosColor(todosLosProductos);
                
                // Mostrar todos los productos inicialmente
                aplicarFiltros();

            } catch (error) {
                console.error("‚ùå Error al cargar los productos:", error);
                errorElement.textContent = 'Error al cargar los productos. Por favor, intenta de nuevo m√°s tarde.';
                errorElement.style.display = 'block';
            } finally {
                loadingElement.style.display = 'none';
            }
        }

        // Event listener para clicks en productos
        document.getElementById('productos-grid').addEventListener('click', async (e) => {
            const productoCard = e.target.closest('.producto-card');
            if (productoCard) {
                const producto = todosLosProductos.find(p => p.id === productoCard.dataset.productId);
                if (producto) {
                    console.log('üëÜ Click en producto:', {
                        id: producto.id,
                        nombre: producto.nombre,
                        categoria: producto.categoria
                    });
                    
                    // Registrar vista del producto
                    try {
                        console.log('üìä Registrando interacci√≥n con producto...');
                        await trackProductView({
                            product_id: producto.id,
                            product_name: producto.nombre,
                            product_category: producto.categoria
                        });
                        console.log('‚úÖ Interacci√≥n registrada correctamente');
                    } catch (error) {
                        console.error('‚ùå Error al registrar interacci√≥n:', error);
                    }
                }
            }
        });

        // Cargar productos cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', cargarProductos);
    </script>

    <!-- Scripts -->
    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/navbar-loader.js"></script>
</body>
</html> 